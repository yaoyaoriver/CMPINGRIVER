<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>清邁萍河水位監測系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;500;700&family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Neutrals with Action Colors -->
    <!-- Application Structure Plan: The application is designed as a real-time dashboard. The primary user goal is to quickly assess the current river status. The structure starts with a station selector, as it's the main control. This is followed by large, color-coded Key Performance Indicator (KPI) cards for at-a-glance information (current level, flow, status). A historical line chart provides essential context to the current data, showing the recent trend. Finally, a static information section explains the meaning of the status levels. This top-down structure (Control -> Key Info -> Context -> Details) is highly intuitive for a monitoring application. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Station Selection -> Goal: Organize/Filter -> Viz/Presentation: Dropdown Menu -> Interaction: On-change event updates the entire dashboard -> Justification: Allows users to focus on a specific, relevant location. Standard and intuitive for selection. -> Library/Method: HTML <select> + JS.
        - Report Info: Current Water Level/Flow -> Goal: Inform (at a glance) -> Viz/Presentation: Large text KPI cards with color-coding -> Interaction: N/A (Display only) -> Justification: Highlights the most critical, current data for rapid assessment. Color provides an immediate qualitative indicator. -> Library/Method: HTML/Tailwind + JS for dynamic content.
        - Report Info: Historical Water Level Data (24h) -> Goal: Show Change/Trend -> Viz/Presentation: Line Chart -> Interaction: Hover to see exact values at specific times -> Justification: A line chart is the best way to visualize time-series data and understand if the situation is improving or worsening. -> Library/Method: Chart.js (Canvas).
        - Report Info: Status Threshold Definitions -> Goal: Inform/Context -> Viz/Presentation: Styled Text Block/Table -> Interaction: N/A (Static Reference) -> Justification: Provides necessary context for users to understand the data's meaning and potential danger. -> Library/Method: HTML/Tailwind.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body.lang-zh-TW { font-family: 'Noto Sans TC', sans-serif; }
        body.lang-en { font-family: 'Inter', sans-serif; }
        body.lang-th { font-family: 'Sarabun', sans-serif; }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .chart-container {
            position: relative;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            height: 50vh;
            max-height: 450px;
            width: 100%;
        }
        .status-normal { border-left: 8px solid #22c55e; }
        .status-warning { border-left: 8px solid #facc15; }
        .status-critical { border-left: 8px solid #ef4444; }
        .control-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.2);
            transition: background-color 0.2s;
        }
        .control-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        .control-btn.active {
            background-color: #ffffff;
            color: #3b82f6;
            font-weight: bold;
        }
        .time-range-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background-color: #ffffff;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .time-range-btn:hover {
            background-color: #f3f4f6;
        }
        .time-range-btn.active {
            background-color: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-blue-700 text-white shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 id="app-title" class="text-2xl md:text-3xl font-bold"></h1>
                <p id="app-subtitle" class="text-lg text-blue-200"></p>
            </div>
            <div id="lang-switcher" class="flex space-x-2">
                <button class="control-btn" data-lang="zh-TW">繁體中文</button>
                <button class="control-btn" data-lang="en">English</button>
                <button class="control-btn" data-lang="th">ไทย</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">

        <section id="controls" class="mb-6">
            <div class="max-w-md mx-auto bg-white p-4 rounded-lg shadow">
                <label for="station-select" id="station-select-label" class="block text-lg font-medium text-gray-700 mb-2"></label>
                <select id="station-select" class="block w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </select>
            </div>
        </section>
        
        <section id="dashboard-intro" class="mb-8 text-center max-w-3xl mx-auto">
            <p id="dashboard-intro-p" class="text-gray-600"></p>
        </section>

        <section id="kpi-dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div id="level-card" class="kpi-card flex flex-col justify-between">
                <div>
                    <h2 id="kpi-level-title" class="text-xl font-semibold text-gray-500"></h2>
                    <p id="current-level" class="text-5xl font-bold my-2">--.--</p>
                </div>
                <p id="kpi-level-unit" class="text-sm text-gray-400"></p>
            </div>
            <div id="flow-card" class="kpi-card flex flex-col justify-between">
                 <div>
                    <h2 id="kpi-flow-title" class="text-xl font-semibold text-gray-500"></h2>
                    <p id="current-flow" class="text-5xl font-bold my-2">--.--</p>
                 </div>
                <p id="kpi-flow-unit" class="text-sm text-gray-400"></p>
            </div>
            <div id="status-card" class="kpi-card flex flex-col justify-between">
                 <div>
                    <h2 id="kpi-status-title" class="text-xl font-semibold text-gray-500"></h2>
                    <p id="current-status" class="text-5xl font-bold my-2"></p>
                 </div>
                <p id="last-updated" class="text-sm text-gray-400"></p>
            </div>
        </section>

        <section id="chart-section" class="mb-8">
            <div class="flex justify-center mb-4 space-x-2" id="time-range-switcher">
                 <button class="time-range-btn" data-range="1" id="btn-24h"></button>
                 <button class="time-range-btn" data-range="3" id="btn-3d"></button>
                 <button class="time-range-btn" data-range="7" id="btn-7d"></button>
                 <button class="time-range-btn" data-range="30" id="btn-30d"></button>
            </div>
            <div class="chart-container mx-auto">
                <canvas id="waterLevelChart"></canvas>
            </div>
        </section>
        
        <section id="historical-chart-section" class="mt-12">
            <div class="text-center mb-4">
                <h2 id="historical-title" class="text-2xl font-bold"></h2>
                <p id="historical-intro" class="text-gray-600 max-w-3xl mx-auto mt-2"></p>
            </div>
            <div class="chart-container mx-auto">
                <canvas id="historicalFloodChart"></canvas>
            </div>
        </section>
        
        <section id="secondary-historical-chart-section" class="mt-12">
            <div class="text-center mb-4">
                <h2 id="secondary-historical-title" class="text-2xl font-bold"></h2>
                <p id="secondary-historical-intro" class="text-gray-600 max-w-3xl mx-auto mt-2"></p>
            </div>
            <div class="chart-container mx-auto">
                <canvas id="secondaryHistoricalFloodChart"></canvas>
            </div>
        </section>

        <section id="info-section" class="bg-white p-6 rounded-lg shadow mt-12">
            <h2 id="threshold-title" class="text-2xl font-bold mb-4"></h2>
             <p id="threshold-intro" class="text-gray-600 mb-4"></p>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-100">
                        <tr>
                            <th id="table-header-status" class="p-3 font-semibold"></th>
                            <th id="table-header-color" class="p-3 font-semibold"></th>
                            <th id="table-header-desc" class="p-3 font-semibold"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b">
                            <td id="status-normal-label" class="p-3 font-medium"></td>
                            <td class="p-3"><div class="w-6 h-6 bg-green-500 rounded-full"></div></td>
                            <td id="status-normal-desc" class="p-3"></td>
                        </tr>
                        <tr class="border-b">
                            <td id="status-warning-label" class="p-3 font-medium"></td>
                            <td class="p-3"><div class="w-6 h-6 bg-yellow-400 rounded-full"></div></td>
                            <td id="status-warning-desc" class="p-3"></td>
                        </tr>
                        <tr>
                            <td id="status-critical-label" class="p-3 font-medium"></td>
                            <td class="p-3"><div class="w-6 h-6 bg-red-500 rounded-full"></div></td>
                            <td id="status-critical-desc" class="p-3"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
             <div id="threshold-info" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 id="threshold-info-title" class="font-bold text-blue-800"></h3>
                <p id="threshold-info-details" class="text-blue-700"></p>
            </div>
        </section>
    </main>

    <footer class="mt-8 py-4 bg-gray-800 text-white text-center">
        <p id="footer-demo"></p>
        <p id="footer-source" class="text-sm text-gray-400"></p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let waterLevelChart = null;
            let historicalFloodChart = null;
            let secondaryHistoricalFloodChart = null;
            let currentLanguage = 'th';
            let currentTimeRange = 1;

            const translations = {
                'zh-TW': {
                    appTitle: '萍河水位監測系統',
                    appSubtitle: '清邁府',
                    stationSelectLabel: '選擇監測站：',
                    dashboardIntro: '此部分提供您所選測站的最新水情摘要，包括目前水位、流量及整體警戒狀態。下方圖表顯示所選時間範圍內的水位趨勢，以助您快速評估情況。',
                    kpiLevelTitle: '目前水位',
                    kpiLevelUnit: '相對平均海平面',
                    kpiFlowTitle: '水流量',
                    kpiFlowUnit: '立方公尺/秒',
                    kpiStatusTitle: '狀態',
                    lastUpdated: '最後更新：',
                    thresholdTitle: '警戒閾值',
                    thresholdIntro: '水位會與各測站的堤岸高度進行比較以評估狀況。主要分為3個等級，並以顏色區分，以便清晰、快速地理解。',
                    tableHeaderStatus: '狀態',
                    tableHeaderColor: '顏色',
                    tableHeaderDesc: '描述',
                    statusNormal: '正常',
                    statusNormalDesc: '水位低於注意閾值，情況安全。',
                    statusWarning: '注意',
                    statusWarningDesc: '水位正在上漲並接近危險閾值，建議密切監測。',
                    statusCritical: '危險',
                    statusCriticalDesc: '水位已達或接近堤岸高度，洪水風險高，請準備應對。',
                    thresholdInfoTitle: '測站閾值',
                    bankLevel: '堤岸高度',
                    warningLevel: '注意',
                    criticalLevel: '危險',
                    footerDemo: '模擬數據僅供示範之用。',
                    footerSource: '參考來源：水文與農業資訊研究所（公共組織）',
                    chartLabel: '水位',
                    chartTimeAxis: '時間',
                    chartLevelAxis: '水位 (公尺, 平均海平面)',
                    chartTitle: '即時水位趨勢',
                    chartWarningLabel: '注意水位',
                    chartCriticalLabel: '危險水位',
                    unitMeter: '公尺',
                    statusLoading: '載入中',
                    stationNames: {
                        'P.1': 'P.1 (納瓦拉大橋, 清邁市區)',
                        'P.67': 'P.67 (Mae-tae村, San Sai區)',
                        'P.75': 'P.75 (Tha Pong村, Mae Wang區)',
                    },
                    day1: '24小時',
                    day3: '3天',
                    day7: '7天',
                    day30: '30天',
                    historicalTitle: '歷史洪水事件回顧 (2022年10月)',
                    historicalIntro: '此圖表顯示2022年10月P.1測站發生重大洪水事件（水位超過5公尺）前後60天的水位變化，以供歷史參考與比較。',
                    historicalChartTitle: '2022年10月洪水事件 (P.1 測站)',
                    historicalPeak: '歷史洪峰',
                    historicalXAxis: '日期',
                    secondaryHistoricalTitle: '歷史洪水事件回顧 (2022年9月)',
                    secondaryHistoricalIntro: '此圖表顯示2022年9月P.1測站發生的次高水位洪水事件，其高峰接近4.8公尺。',
                    secondaryHistoricalChartTitle: '2022年9月洪水事件 (P.1 測站)',
                },
                'en': {
                    appTitle: 'Ping River Water Level Monitoring System',
                    appSubtitle: 'Chiang Mai Province',
                    stationSelectLabel: 'Select Monitoring Station:',
                    dashboardIntro: 'This section provides a summary of the latest water situation from your selected station, including the current water level, flow rate, and overall alert status. The chart below shows the water level trend over the selected time range to help you quickly assess the situation.',
                    kpiLevelTitle: 'Current Water Level',
                    kpiLevelUnit: 'Relative to mean sea level',
                    kpiFlowTitle: 'Water Flow Rate',
                    kpiFlowUnit: 'm³/s',
                    kpiStatusTitle: 'Status',
                    lastUpdated: 'Last Updated:',
                    thresholdTitle: 'Warning Thresholds',
                    thresholdIntro: 'The water level is compared against each station\'s bank level to assess the situation. It is divided into 3 main levels, represented by colors for clarity and quick understanding.',
                    tableHeaderStatus: 'Status',
                    tableHeaderColor: 'Color',
                    tableHeaderDesc: 'Description',
                    statusNormal: 'Normal',
                    statusNormalDesc: 'Water level is below the warning threshold. The situation is safe.',
                    statusWarning: 'Warning',
                    statusWarningDesc: 'Water level is rising and approaching the critical threshold. Close monitoring is advised.',
                    statusCritical: 'Critical',
                    statusCriticalDesc: 'Water level is at or near the bank level. High risk of flooding. Prepare for action.',
                    thresholdInfoTitle: 'Thresholds for Station',
                    bankLevel: 'Bank Level',
                    warningLevel: 'Warning',
                    criticalLevel: 'Critical',
                    footerDemo: 'Simulated data for demonstration purposes only.',
                    footerSource: 'Reference Source: Hydro and Agro Informatics Institute (Public Organization)',
                    chartLabel: 'Water Level',
                    chartTimeAxis: 'Time',
                    chartLevelAxis: 'Water Level (m. MSL)',
                    chartTitle: 'Real-time Water Level Trend',
                    chartWarningLabel: 'Warning Level',
                    chartCriticalLabel: 'Critical Level',
                    unitMeter: 'm',
                    statusLoading: 'Loading',
                    stationNames: {
                        'P.1': 'P.1 (Nawarat Bridge, Mueang District)',
                        'P.67': 'P.67 (Ban Mae-tae, San Sai District)',
                        'P.75': 'P.75 (Ban Tha Pong, Mae Wang District)',
                    },
                    day1: '24 Hours',
                    day3: '3 Days',
                    day7: '7 Days',
                    day30: '30 Days',
                    historicalTitle: 'Historical Flood Event Review (Oct 2022)',
                    historicalIntro: 'This chart shows the 60-day water level variation around the Oct 2022 major flood event (level exceeding 5 meters) at Station P.1, for historical reference and comparison.',
                    historicalChartTitle: 'Oct 2022 Flood Event (Station P.1)',
                    historicalPeak: 'Historical Peak',
                    historicalXAxis: 'Date',
                    secondaryHistoricalTitle: 'Historical Flood Event Review (Sep 2022)',
                    secondaryHistoricalIntro: 'This chart shows the second-highest flood event at Station P.1 in September 2022, which peaked near 4.8 meters.',
                    secondaryHistoricalChartTitle: 'Sep 2022 Flood Event (Station P.1)',
                },
                'th': {
                    appTitle: 'ระบบติดตามสถานการณ์น้ำแม่น้ำปิง',
                    appSubtitle: 'จังหวัดเชียงใหม่',
                    stationSelectLabel: 'เลือกสถานีวัดน้ำ:',
                    dashboardIntro: 'ส่วนนี้จะแสดงข้อมูลสรุปสถานการณ์น้ำล่าสุดจากสถานีที่คุณเลือก ประกอบด้วยระดับน้ำปัจจุบัน ปริมาณน้ำไหลผ่าน และสถานะการเตือนภัยโดยรวม แผนภูมิด้านล่างจะแสดงแนวโน้มของระดับน้ำตามช่วงเวลาที่เลือก เพื่อช่วยให้เห็นภาพรวมและประเมินสถานการณ์ได้อย่างรวดเร็ว',
                    kpiLevelTitle: 'ระดับน้ำปัจจุบัน',
                    kpiLevelUnit: 'เทียบกับระดับตลิ่ง',
                    kpiFlowTitle: 'ปริมาณน้ำไหลผ่าน',
                    kpiFlowUnit: 'ลบ.ม./วินาที',
                    kpiStatusTitle: 'สถานะ',
                    lastUpdated: 'ข้อมูลล่าสุด:',
                    thresholdTitle: 'เกณฑ์การเตือนภัย',
                    thresholdIntro: 'ระดับน้ำจะถูกเปรียบเทียบกับระดับตลิ่งของแต่ละสถานีเพื่อประเมินสถานการณ์ โดยแบ่งออกเป็น 3 ระดับหลัก ซึ่งจะแสดงด้วยสีเพื่อความชัดเจนและความรวดเร็วในการทำความเข้าใจ',
                    tableHeaderStatus: 'สถานะ',
                    tableHeaderColor: 'สี',
                    tableHeaderDesc: 'คำอธิบาย',
                    statusNormal: 'ปกติ',
                    statusNormalDesc: 'ระดับน้ำยังอยู่ต่ำกว่าระดับเฝ้าระวัง สถานการณ์ยังอยู่ในเกณฑ์ปลอดภัย',
                    statusWarning: 'เฝ้าระวัง',
                    statusWarningDesc: 'ระดับน้ำสูงขึ้นและเข้าใกล้ระดับวิกฤต ควรเริ่มติดตามสถานการณ์อย่างใกล้ชิด',
                    statusCritical: 'วิกฤต',
                    statusCriticalDesc: 'ระดับน้ำสูงถึงหรือใกล้จะล้นตลิ่ง มีความเสี่ยงที่จะเกิดน้ำท่วม ควรเตรียมพร้อมรับมือ',
                    thresholdInfoTitle: 'เกณฑ์ของสถานี',
                    bankLevel: 'ระดับตลิ่ง',
                    warningLevel: 'เฝ้าระวัง',
                    criticalLevel: 'วิกฤต',
                    footerDemo: 'ข้อมูลจำลองเพื่อการสาธิตเท่านั้น',
                    footerSource: 'แหล่งข้อมูลอ้างอิง: สถาบันสารสนเทศทรัพยากรน้ำ (องค์การมหาชน)',
                    chartLabel: 'ระดับน้ำ',
                    chartTimeAxis: 'เวลา',
                    chartLevelAxis: 'ระดับน้ำ (เมตร รทก.)',
                    chartTitle: 'แนวโน้มระดับน้ำปัจจุบัน',
                    chartWarningLabel: 'ระดับเฝ้าระวัง',
                    chartCriticalLabel: 'ระดับวิกฤต',
                    unitMeter: 'ม.',
                    statusLoading: 'กำลังโหลด',
                    stationNames: {
                        'P.1': 'P.1 (สะพานนวรัฐ, อ.เมือง)',
                        'P.67': 'P.67 (บ้านแม่แต, อ.สันทราย)',
                        'P.75': 'P.75 (บ้านท่าโป่ง, อ.แม่วาง)',
                    },
                    day1: '24 ชั่วโมง',
                    day3: '3 วัน',
                    day7: '7 วัน',
                    day30: '30 วัน',
                    historicalTitle: 'ทบทวนเหตุการณ์น้ำท่วม (ต.ค. 2565)',
                    historicalIntro: 'แผนภูมินี้แสดงการเปลี่ยนแปลงของระดับน้ำในช่วง 60 วัน ของเหตุการณ์น้ำท่วมครั้งใหญ่เมื่อเดือนตุลาคม 2565 (ระดับน้ำเกิน 5 เมตร) ที่สถานี P.1 เพื่อใช้เป็นข้อมูลอ้างอิงและเปรียบเทียบในอดีต',
                    historicalChartTitle: 'เหตุการณ์น้ำท่วม ต.ค. 2565 (สถานี P.1)',
                    historicalPeak: 'จุดสูงสุดในอดีต',
                    historicalXAxis: 'วันที่',
                    secondaryHistoricalTitle: 'ทบทวนเหตุการณ์น้ำท่วม (ก.ย. 2565)',
                    secondaryHistoricalIntro: 'แผนภูมินี้แสดงเหตุการณ์น้ำท่วมสูงสุดเป็นอันดับสองที่สถานี P.1 ในเดือนกันยายน 2565 ซึ่งมีระดับน้ำสูงสุดใกล้ 4.8 เมตร',
                    secondaryHistoricalChartTitle: 'เหตุการณ์น้ำท่วม ก.ย. 2565 (สถานี P.1)',
                }
            };

            const setLanguage = (lang) => {
                currentLanguage = lang;
                const t = translations[lang];
                document.documentElement.lang = lang;
                document.body.className = `text-gray-800 lang-${lang}`;
                
                document.getElementById('app-title').textContent = t.appTitle;
                document.getElementById('app-subtitle').textContent = t.appSubtitle;
                document.getElementById('station-select-label').textContent = t.stationSelectLabel;
                document.getElementById('dashboard-intro-p').textContent = t.dashboardIntro;
                document.getElementById('kpi-level-title').textContent = t.kpiLevelTitle;
                document.getElementById('kpi-flow-title').textContent = t.kpiFlowTitle;
                document.getElementById('kpi-status-title').textContent = t.kpiStatusTitle;
                document.getElementById('kpi-flow-unit').textContent = t.kpiFlowUnit;
                document.getElementById('threshold-title').textContent = t.thresholdTitle;
                document.getElementById('threshold-intro').textContent = t.thresholdIntro;
                document.getElementById('table-header-status').textContent = t.tableHeaderStatus;
                document.getElementById('table-header-color').textContent = t.tableHeaderColor;
                document.getElementById('table-header-desc').textContent = t.tableHeaderDesc;
                document.getElementById('status-normal-label').textContent = t.statusNormal;
                document.getElementById('status-normal-desc').textContent = t.statusNormalDesc;
                document.getElementById('status-warning-label').textContent = t.statusWarning;
                document.getElementById('status-warning-desc').textContent = t.statusWarningDesc;
                document.getElementById('status-critical-label').textContent = t.statusCritical;
                document.getElementById('status-critical-desc').textContent = t.statusCriticalDesc;
                document.getElementById('footer-demo').textContent = t.footerDemo;
                document.getElementById('footer-source').textContent = t.footerSource;
                document.getElementById('btn-24h').textContent = t.day1;
                document.getElementById('btn-3d').textContent = t.day3;
                document.getElementById('btn-7d').textContent = t.day7;
                document.getElementById('btn-30d').textContent = t.day30;
                document.getElementById('historical-title').textContent = t.historicalTitle;
                document.getElementById('historical-intro').textContent = t.historicalIntro;
                document.getElementById('secondary-historical-title').textContent = t.secondaryHistoricalTitle;
                document.getElementById('secondary-historical-intro').textContent = t.secondaryHistoricalIntro;
                
                document.querySelectorAll('#lang-switcher .control-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.lang === lang);
                });

                populateStationSelect();
                updateDashboard(stationSelect.value);
                createHistoricalFloodChart();
                createSecondaryHistoricalFloodChart();
            };

            const generateHistoryData = (baseLevel, days = 1) => {
                let data = [];
                let currentDate = new Date();
                let hours = days * 24;
                for (let i = hours; i >= 0; i--) {
                    let date = new Date(currentDate.getTime() - i * 60 * 60 * 1000);
                    let fluctuation = (Math.random() - 0.5) * 0.5;
                    let trend = (hours - i) / hours * (Math.random() * 0.3 - 0.1);
                    let level = baseLevel + fluctuation + trend;
                    
                    let timeFormat;
                    if (days === 1) {
                         timeFormat = date.toLocaleTimeString(currentLanguage.split('-')[0], { hour: '2-digit', minute: '2-digit' });
                    } else {
                         timeFormat = date.toLocaleString(currentLanguage.split('-')[0], { day: 'numeric', month: 'short', hour: '2-digit' });
                    }

                    data.push({
                        time: timeFormat,
                        level: parseFloat(level.toFixed(2))
                    });
                }
                return data;
            };
            
            const generateHistoricalFloodData = () => {
                let data = [];
                let baseLevel = 2.5;
                let peakDay = 30;
                for (let i = 1; i <= 60; i++) {
                    let level;
                    if (i < peakDay) {
                        level = baseLevel + (i / peakDay) * 2.0 + Math.random() * 0.5;
                    } else {
                        level = baseLevel + 2.0 - ((i - peakDay) / (60 - peakDay)) * 1.5 + Math.random() * 0.5;
                    }
                    if (i > 25 && i < 35) {
                         level += (1 - Math.abs(i - peakDay)/5) * 2.1;
                    }
                    data.push(level.toFixed(2));
                }
                return data;
            };
            
            const generateSecondaryHistoricalFloodData = () => {
                let data = [];
                let baseLevel = 2.4;
                let peakDay = 25;
                for (let i = 1; i <= 45; i++) {
                    let level;
                    if (i < peakDay) {
                        level = baseLevel + (i / peakDay) * 1.5 + Math.random() * 0.4;
                    } else {
                        level = baseLevel + 1.5 - ((i - peakDay) / (45 - peakDay)) * 1.2 + Math.random() * 0.4;
                    }
                     if (i > 20 && i < 30) {
                         level += (1 - Math.abs(i - peakDay)/5) * 1.2;
                    }
                    data.push(level.toFixed(2));
                }
                return data;
            };

            const stationData = {
                'P.1': { id: 'P.1', bank_level: 3.70, warning_level: 2.70, critical_level: 3.20, base_level: 2.45, flow: 95.8 },
                'P.67': { id: 'P.67', bank_level: 4.80, warning_level: 3.80, critical_level: 4.30, base_level: 3.95, flow: 150.2 },
                'P.75': { id: 'P.75', bank_level: 8.50, warning_level: 6.50, critical_level: 7.50, base_level: 5.1, flow: 77.4 }
            };
            
            const stationSelect = document.getElementById('station-select');
            
            const populateStationSelect = () => {
                const t = translations[currentLanguage];
                const currentVal = stationSelect.value;
                stationSelect.innerHTML = '';
                Object.values(stationData).forEach(station => {
                    const option = document.createElement('option');
                    option.value = station.id;
                    option.textContent = t.stationNames[station.id];
                    stationSelect.appendChild(option);
                });
                if(currentVal) stationSelect.value = currentVal;
            };

            const updateDashboard = (stationId) => {
                const data = stationData[stationId];
                if (!data) return;
                
                const t = translations[currentLanguage];
                const history = generateHistoryData(data.base_level, currentTimeRange);
                const currentLevel = history[history.length - 1].level;
                
                const levelCard = document.getElementById('level-card');
                const flowCard = document.getElementById('flow-card');
                const statusCard = document.getElementById('status-card');
                
                document.getElementById('current-level').textContent = `${currentLevel.toFixed(2)} ${t.unitMeter}`;
                document.getElementById('kpi-level-unit').textContent = t.kpiLevelUnit;
                document.getElementById('current-flow').textContent = data.flow.toFixed(2);
                document.getElementById('last-updated').textContent = `${t.lastUpdated} ${new Date().toLocaleTimeString(currentLanguage, { hour: '2-digit', minute: '2-digit' })}`;

                let status, colorClass;
                if (currentLevel >= data.critical_level) {
                    status = t.statusCritical;
                    colorClass = 'status-critical';
                } else if (currentLevel >= data.warning_level) {
                    status = t.statusWarning;
                    colorClass = 'status-warning';
                } else {
                    status = t.statusNormal;
                    colorClass = 'status-normal';
                }
                document.getElementById('current-status').textContent = status;

                [levelCard, flowCard, statusCard].forEach(card => {
                    card.className = 'kpi-card flex flex-col justify-between';
                    card.classList.add(colorClass);
                });

                document.getElementById('threshold-info-title').textContent = `${t.thresholdInfoTitle} ${t.stationNames[data.id]}:`;
                document.getElementById('threshold-info-details').textContent = `${t.bankLevel}: ${data.bank_level.toFixed(2)} ${t.unitMeter} | ${t.warningLevel}: ${data.warning_level.toFixed(2)} ${t.unitMeter} | ${t.criticalLevel}: ${data.critical_level.toFixed(2)} ${t.unitMeter}`;
                
                createOrUpdateChart(data, history);
            };

            const createOrUpdateChart = (stationData, historyData) => {
                const ctx = document.getElementById('waterLevelChart').getContext('2d');
                if (waterLevelChart) {
                    waterLevelChart.destroy();
                }
                const t = translations[currentLanguage];
                const labels = historyData.map(d => d.time);
                const dataPoints = historyData.map(d => d.level);

                waterLevelChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${t.chartLabel} (${t.unitMeter})`,
                            data: dataPoints,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: `${t.chartTitle} - ${t.stationNames[stationData.id]}`,
                                font: { size: 18, weight: 'bold' },
                                padding: { top: 10, bottom: 20 }
                            },
                            annotation: {
                                annotations: {
                                    warningLine: {
                                        type: 'line', yMin: stationData.warning_level, yMax: stationData.warning_level,
                                        borderColor: '#facc15', borderWidth: 2, borderDash: [6, 6],
                                        label: { content: t.chartWarningLabel, enabled: true, position: 'end', backgroundColor: 'rgba(250, 204, 21, 0.8)', color: '#713f12', font: { style: 'normal'} }
                                    },
                                    criticalLine: {
                                        type: 'line', yMin: stationData.critical_level, yMax: stationData.critical_level,
                                        borderColor: '#ef4444', borderWidth: 2, borderDash: [6, 6],
                                        label: { content: t.chartCriticalLabel, enabled: true, position: 'end', backgroundColor: 'rgba(239, 68, 68, 0.8)', color: '#ffffff', font: { style: 'normal'} }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: false, title: { display: true, text: t.chartLevelAxis } },
                            x: { title: { display: true, text: t.chartTimeAxis } }
                        },
                        interaction: { intersect: false, mode: 'index' },
                    }
                });
            };
            
            const createHistoricalFloodChart = () => {
                const ctx = document.getElementById('historicalFloodChart').getContext('2d');
                if(historicalFloodChart) {
                    historicalFloodChart.destroy();
                }
                const t = translations[currentLanguage];
                const dataPoints = generateHistoricalFloodData();
                
                const labels = [];
                const startDate = new Date('2022-09-06');
                for (let i = 0; i < 60; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    labels.push(currentDate.toLocaleDateString(currentLanguage.split('-')[0], { month: 'short', day: 'numeric' }));
                }

                historicalFloodChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${t.chartLabel} (${t.unitMeter})`,
                            data: dataPoints,
                            borderColor: '#be123c',
                            backgroundColor: 'rgba(190, 18, 60, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                        }]
                    },
                     options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: t.historicalChartTitle,
                                font: { size: 18, weight: 'bold' },
                                padding: { top: 10, bottom: 20 }
                            },
                             annotation: {
                                annotations: {
                                    majorFloodLine: {
                                        type: 'line', yMin: 5.0, yMax: 5.0,
                                        borderColor: '#991b1b', borderWidth: 3, borderDash: [8, 8],
                                        label: { content: t.historicalPeak, enabled: true, position: 'end', backgroundColor: 'rgba(153, 27, 27, 0.8)', color: '#ffffff', font: { style: 'bold'} }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: false, title: { display: true, text: t.chartLevelAxis } },
                            x: { title: { display: true, text: t.historicalXAxis } }
                        },
                        interaction: { intersect: false, mode: 'index' },
                    }
                });
            };

            const createSecondaryHistoricalFloodChart = () => {
                const ctx = document.getElementById('secondaryHistoricalFloodChart').getContext('2d');
                if(secondaryHistoricalFloodChart) {
                    secondaryHistoricalFloodChart.destroy();
                }
                const t = translations[currentLanguage];
                const dataPoints = generateSecondaryHistoricalFloodData();
                
                const labels = [];
                const startDate = new Date('2022-08-20');
                for (let i = 0; i < 45; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    labels.push(currentDate.toLocaleDateString(currentLanguage.split('-')[0], { month: 'short', day: 'numeric' }));
                }

                secondaryHistoricalFloodChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${t.chartLabel} (${t.unitMeter})`,
                            data: dataPoints,
                            borderColor: '#c2410c',
                            backgroundColor: 'rgba(194, 65, 12, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                        }]
                    },
                     options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: t.secondaryHistoricalChartTitle,
                                font: { size: 18, weight: 'bold' },
                                padding: { top: 10, bottom: 20 }
                            },
                             annotation: {
                                annotations: {
                                    majorFloodLine: {
                                        type: 'line', yMin: 4.7, yMax: 4.7,
                                        borderColor: '#9a3412', borderWidth: 2, borderDash: [8, 8],
                                        label: { content: t.historicalPeak, enabled: true, position: 'end', backgroundColor: 'rgba(154, 52, 18, 0.8)', color: '#ffffff', font: { style: 'bold'} }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: false, title: { display: true, text: t.chartLevelAxis } },
                            x: { title: { display: true, text: t.historicalXAxis } }
                        },
                        interaction: { intersect: false, mode: 'index' },
                    }
                });
            };
            
            document.getElementById('lang-switcher').addEventListener('click', (e) => {
                if (e.target.classList.contains('control-btn')) {
                    const lang = e.target.dataset.lang;
                    if (lang) {
                        setLanguage(lang);
                    }
                }
            });
            
            document.getElementById('time-range-switcher').addEventListener('click', (e) => {
                if (e.target.classList.contains('time-range-btn')) {
                    const range = e.target.dataset.range;
                    if (range) {
                        currentTimeRange = parseInt(range, 10);
                        document.querySelectorAll('#time-range-switcher .time-range-btn').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.range === range);
                        });
                        updateDashboard(stationSelect.value);
                    }
                }
            });

            stationSelect.addEventListener('change', (e) => {
                updateDashboard(e.target.value);
            });
            
            setLanguage('th');
            document.querySelector('#time-range-switcher .time-range-btn[data-range="1"]').classList.add('active');
        });
    </script>
</body>
</html>
